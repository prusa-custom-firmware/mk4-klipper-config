# Do not edit this file!
# You can override settings from this file by adding a section of the same name
# in printer.cfg or another file included from it after the base configuration.

[printer]
kinematics: cartesian
# include/marlin/Configuration_MK4.h L801
max_velocity: 300
max_z_velocity: 40
# include/marlin/Configuration_MK4.h L816
max_accel: 7000
max_z_accel: 200  # 750 in Buddy FW seems to be too high
# Jerk hwlimit is 10, but it is set at 8 in the slicer. A common SCV estimate
# is to use jerk / sqrt(2).
# Since Klipper outputs for PrusaSlicer and OrcaSlicer do not set jerk in the
# gcode output, the default config here limits to the approximate equivalent of
# a jerk of 8.
square_corner_velocity: 5.65
minimum_cruise_ratio: 0

[stepper_x]
step_pin: PD7
dir_pin: PD6
enable_pin: !PB9
full_steps_per_rotation: 400
microsteps: 8
rotation_distance: 32  # 400 * 8 / 100
endstop_pin: tmc2130_stepper_x:virtual_endstop
position_endstop: -2 # -1 in include/marlin/Configuration_MK4.h L1159
position_min: -2
position_max: 251
homing_speed: 64
homing_retract_dist: 0

[tmc2130 stepper_x]
cs_pin: PG15
spi_bus: spi3a
diag0_pin: ^!PG9
run_current: 0.55
sense_resistor: 0.22
driver_SGT: -64
interpolate: true
# The following is from lib/Marlin/Marlin/src/module/stepper/trinamic.cpp L126
# with values from lib/Marlin/Marlin/src/feature/tmc_util.h CHOPPER_PRUSAMK3_24V 
driver_TBL: 1
driver_TOFF: 3
driver_HEND: 1
driver_HSTRT: 5
driver_IHOLDDELAY: 10
driver_TPOWERDOWN: 128
driver_PWM_FREQ: 1
driver_PWM_AUTOSCALE: False
driver_PWM_GRAD: 12
driver_PWM_AMPL: 22

[stepper_y]
step_pin: PD5
dir_pin: !PD4
enable_pin: !PB9
microsteps: 8
full_steps_per_rotation: 400
rotation_distance: 32  # 400 * 8 / 100
endstop_pin: tmc2130_stepper_y:virtual_endstop
position_endstop: -4 # include/marlin/Configuration_MK4.h L1160
position_min: -4.5
position_max: 211
homing_speed: 64
homing_retract_dist: 0

[tmc2130 stepper_y]
cs_pin: PB5
spi_bus: spi3a
diag0_pin: ^!PE13
run_current: 0.7
sense_resistor: 0.22
driver_SGT: -64
interpolate: true
# The following is from lib/Marlin/Marlin/src/module/stepper/trinamic.cpp L126
# with values from lib/Marlin/Marlin/src/feature/tmc_util.h CHOPPER_PRUSAMK3_24V 
driver_TBL: 1
driver_TOFF: 3
driver_HEND: 1
driver_HSTRT: 5
driver_IHOLDDELAY: 10
driver_TPOWERDOWN: 128
driver_PWM_FREQ: 1
driver_PWM_AUTOSCALE: False
driver_PWM_GRAD: 13
driver_PWM_AMPL: 22

[stepper_z]
step_pin: PD3
dir_pin: PD2
enable_pin: !PB8
microsteps: 16
rotation_distance: 8
# A pin is required here, but not actually used. This is an ethernet port pin.
endstop_pin: PB11
position_min: -2
position_endstop: 0
position_max: 220
homing_speed: 32

# Match probe speed
homing_retract_speed: 5
homing_retract_dist: 2
second_homing_speed: 1  

[tmc2130 stepper_z]
cs_pin: PF15
spi_bus: spi3a
stealthchop_threshold: 999999 # include/marlin/Configuration_MK4_adv.h L1683
run_current: 0.6 # include/marlin/Configuration_MK4_adv.h L1586
sense_resistor: 0.22
diag0_pin: ^!PB4
interpolate: true
# The following is from lib/Marlin/Marlin/src/module/stepper/trinamic.cpp L126
# with values from lib/Marlin/Marlin/src/feature/tmc_util.h CHOPPER_PRUSAMK3_24V 
#driver_TBL: 1
#driver_TOFF: 3
#driver_HEND: 1
#driver_HSTRT: 5
#driver_IHOLDDELAY: 10
#driver_TPOWERDOWN: 128
#driver_PWM_FREQ: 1
#driver_PWM_AUTOSCALE: True
#driver_PWM_GRAD: 15
#driver_PWM_AMPL: 180

[force_move]
enable_force_move: True

[homing_override]
axes: xyz
gcode:
    {% set safe_z = 2 %}
    {% set t = printer.toolhead %}
    {% set home_x = 'x' not in t.homed_axes %}
    {% set home_y = 'y' not in t.homed_axes %}

    {% if home_x or home_y %}
      {% if 'z' not in t.homed_axes %}
        SET_KINEMATIC_POSITION Z=0
        G90
        G0 Z{safe_z} F3600
      {% else %}
        {% if t.position.z < safe_z %}
          G90
          G0 Z{safe_z} F3600
        {% endif %}
      {% endif %}
    {% endif %}

    {% if home_x %}
    G28 X
    G0 X0 F3600
    {% endif %}

    {% if home_y %}
    G28 Y
    G0 Y0 F3600
    {% endif %}

    SET_GCODE_OFFSET Z=0
    G90  # absolute move
    G1 X14 Y3.5 F3600  # move to X/Y position for homing

    # Pause to try avoid vibrations
    G4 P1000

    # soft home the z axis to its limit so it can be moved:
    SET_KINEMATIC_POSITION Z={printer.toolhead.axis_maximum[2]}

    # Fast approach and tap
    PROBE PROBE_SPEED=6  # override the speed for faster homing
    _HOME_Z_FROM_LAST_PROBE

    G91
    G1 Z{safe_z} F1800

    # probe at standard speed
    PROBE
    _HOME_Z_FROM_LAST_PROBE

    # lift z to 2mm for clearance
    G91  # relative move
    G1 Z{safe_z} F1800

[gcode_macro _HOME_Z_FROM_LAST_PROBE]
gcode:
    {% set z_probed = printer.probe.last_z_result %}
    {% set z_position = printer.toolhead.position[2] %}
    {% set z_actual = z_position - z_probed %}
    SET_KINEMATIC_POSITION Z={z_actual}

[input_shaper]
shaper_freq_x: 50
shaper_type_x: mzv
shaper_freq_y: 40
shaper_type_y: mzv
