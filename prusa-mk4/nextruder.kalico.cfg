# Do not edit this file!
# You can override settings from this file by adding a section of the same name
# in printer.cfg or another file included from it after the base configuration.

[extruder]
filament_diameter: 1.75
step_pin: PD1
dir_pin: PD0
enable_pin: !PD10
full_steps_per_rotation: 200
microsteps: 16
# Prusa-Firmware-Buddy/include/marlin/Configuration_MK4.h L749
# DEFAULT_AXIS_STEPS_PER_UNIT for E is 380
rotation_distance: 8.42105263 # 200 * 16 / 380
heater_pin: PB1
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PC0
pullup_resistor: 1000
min_temp: 0
max_temp: 300
min_extrude_temp: 170
max_extrude_cross_section: 8  # This is set high for Prusa-style prime
max_extrude_only_distance: 120  # A little longer than extruder to nozzle
# Max velocity and accel are set to the Prusa Slicer "normal" profile limits,
# not the HWLIMIT specified in firmware, as it doesn't seem to be possible to
# specify reduced limits at runtime.
max_extrude_only_accel: 4000  # retract accel only 2500 in slicer, 6000 in fw
max_extrude_only_velocity: 100  # Matches firmware
# Firmware limits include/marlin/Configuration_MK4.h L816, L801 :
# max_extrude_only_accel: 6000
# max_extrude_only_velocity: 100
# include/marlin/Configuration_MK4.h L856
instantaneous_corner_velocity: 10
# The heater (bed and extruder) PWM runs at 27kHz in Buddy FW. There is audible
# noise if these are run at a lower frequency, or clicking at a very low
# frequency.
pwm_cycle_time: 0.00004 # 25kHz
control: mpc
heater_power: 40
cooling_fan: fan
filament_density: 1.20
filament_heat_capacity: 1.80

#control: pid
# Copied from Prusa-Firmware-Buddy/include/marlin/Configuration_MK4.h L512+
#pid_Kp: 14.0
#pid_Ki: 1.0
#pid_Kd: 100.0

[tmc2130 extruder]
cs_pin: PF12
spi_bus: spi3a
diag0_pin: PD14
run_current: 0.45
sense_resistor: 0.22
# The following is from lib/Marlin/Marlin/src/module/stepper/trinamic.cpp
# with values from lib/Marlin/Marlin/src/feature/tmc_util.h CHOPPER_PRUSAMK3_24V 
driver_TOFF: 3
driver_HEND: 1
driver_HSTRT: 5
driver_IHOLDDELAY: 10
driver_TPOWERDOWN: 128
driver_PWM_FREQ: 1
driver_PWM_AUTOSCALE: False
driver_PWM_GRAD: 31
driver_PWM_AMPL: 31

[static_digital_output extruder_heater_enable]
pins: PG10

[static_digital_output tach_select]
# The tach for the heatsink fan and part cooling fan are on the  same MCU pin,
# PE10. You can select which one reports with PF13 ("MULTIWIRE").
# Unfortunately Klipper doesn't support this sort of multiplexing. The default
# configuration here is to report the speed of the part cooling fan. To choose
# the heatsink fan instead, add the following to your printer.cfg:
#
# [static_digital_output tach_select]
# pins: !PF13
# [temperature_fan heatsink_fan]
# tachometer_pin: PE10
# [fan]
# tachometer_pin: None
pins: PF13

[temperature_fan heatsink_fan]
pin: PE9
# tachometer_pin: PE10
sensor_pin: PA6
sensor_type: ATC Semitec 104NT-4-R025H42G
pullup_resistor: 33000
min_temp: 0
max_temp: 75
control: pid
shutdown_speed: 1
cycle_time: 0.04 # As measured while running Buddy FW
pid_deriv_time: 10
# Copied from Prusa-Firmware-Buddy/include/marlin/Configuration_MK4.h L602+
target_temp: 36
min_power: 0.2 # PID will try to spin at as low as 20%
pid_Kp: 25.5
pid_Ki: 5
pid_Kd: 300

# Part cooling fan
[fan]
pin: PE11
tachometer_pin: PE10
cycle_time: 0.04  # As measured while running Buddy FW
# off_below: 0.2 # MK4S blower really doesn't sound great below 30%, though

# [nozzle_cleanup]

[load_cell_probe]
sensor_type: hx717
sclk_pin: PG1
dout_pin: PE7
gain: A-128
counts_per_gram: 87.944082
reference_tare_counts: 559000  # 552000 @ ambient, 566000 @ 170C
sensor_orientation: inverted
force_safety_limit: 5000
trigger_force: 50
## probing filter
drift_filter_cutoff_frequency: 0.8
z_offset: 0
speed: 2.0
retry_speed: 50
lift_speed: 6.0
samples: 1
# Prusa are using a vanishingly small 0.23mm retract distance between probes:
# https://github.com/prusa3d/Prusa-Firmware-Buddy/blob/f26c91ba57b004e570a73fb9c9cda0ce3e433b40/include/marlin/Configuration_MK4.h#L1003
sample_retract_dist: 0.23
samples_tolerance: 0.005
samples_tolerance_retries: 3
## Pullback Move control
pullback_distance: 0.12310232644485475  # found with new calibration tool
bad_probe_retries: 8
bad_probe_strategy: circle
# decompression_angle: 78.0  # enable bad tap detection, found with calibration tool
drift_filter_cutoff_frequency: 0.8
buzz_filter_cutoff_frequency: 100
notch_filter_frequencies: 50,60
activate_gcode:
    {% set PROBE_TEMP = 170 %}
    {% set MAX_TEMP = PROBE_TEMP + 5 %}
    {% set ACTUAL_TEMP = printer.extruder.temperature %}
    {% set TARGET_TEMP = printer.extruder.target %}

    {% if TARGET_TEMP > PROBE_TEMP %}
        { action_respond_info('Extruder temperature target of %.1fC is too high for probing, lowering to %.1fC' % (TARGET_TEMP, PROBE_TEMP)) }
        M109 S{ PROBE_TEMP }
    {% else %}
        # Temperature target is already low enough, but nozzle may still be too hot.
        {% if ACTUAL_TEMP > MAX_TEMP %}
            { action_respond_info('Extruder temperature %.1fC is still too high, waiting until below %.1fC' % (ACTUAL_TEMP, MAX_TEMP)) }
            TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={ MAX_TEMP }
        {% endif %}
    {% endif %}
